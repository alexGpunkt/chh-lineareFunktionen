<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>üìê Lineare Funktionen ‚Ä¢ mobil mit PDF</title>
  <!-- jsPDF f√ºr PDF-Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0c0f1c;
      --card-bg: rgba(25, 30, 45, 0.95);
      --border: rgba(90, 190, 255, 0.2);
      --accent: #5abfff;
      --accent-glow: rgba(90, 190, 255, 0.3);
      --text: #f0f4ff;
      --text-dim: #a5b3d9;
      --success: #6fcf97;
      --error: #eb5757;
      --radius: 24px;
      --radius-sm: 16px;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      margin: 0;
    }

    /* Hauptcontainer ‚Äì vollfl√§chig f√ºr mobile */
    .app {
      width: 100%;
      min-height: 100vh;
      background: rgba(15, 20, 30, 0.9);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
    }

    /* Mobile Navigation ‚Äì als Scroll-Leiste unten */
    .mobile-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(10, 15, 25, 0.95);
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0.25rem;
      z-index: 100;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 0.7rem;
      padding: 0.4rem 0.1rem;
      border-radius: 12px;
      transition: all 0.2s;
      gap: 0.2rem;
    }

    .nav-item span {
      font-size: 1.3rem;
    }

    .nav-item.active {
      color: var(--accent);
      background: rgba(90, 190, 255, 0.15);
    }

    /* PDF-Button etwas hervorheben */
    #pdfExportBtn {
      color: #ffd966;
    }
    #pdfExportBtn.active {
      color: #ffd966;
      background: rgba(255, 217, 102, 0.15);
    }

    /* Level-Auswahl */
    .level-select {
      margin: 0 0 1rem 0;
      padding: 0.5rem;
      background: var(--card-bg);
      border-radius: 40px;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 1rem;
      width: 100%;
      max-width: 300px;
    }

    /* Hauptinhalt ‚Äì mit Padding unten f√ºr Navigation */
    .main-content {
      flex: 1;
      padding: 1rem 1rem 5rem 1rem;
      overflow-y: auto;
    }

    /* Hauptbereich ‚Äì vertikale Anordnung f√ºr mobile */
    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Graph-Bereich */
    .graph-area {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .graph-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
      color: var(--accent);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .graph-title span {
      background: rgba(90, 190, 255, 0.15);
      padding: 0.2rem 0.8rem;
      border-radius: 40px;
      border: 1px solid var(--border);
    }

    .svg-container {
      background: #0b0f1a;
      border-radius: var(--radius-sm);
      padding: 0.3rem;
      border: 1px solid var(--border);
      margin-bottom: 1rem;
      overflow: hidden;
      position: relative;
      width: 100%;
      height: 300px; /* Feste H√∂he f√ºr bessere Bedienbarkeit */
      cursor: crosshair;
    }

    .zoomable-svg {
      width: 100%;
      height: 100%;
      transition: transform 0.1s ease;
      transform-origin: 0 0;
    }

    .zoomable-svg svg {
      width: 100%;
      height: 100%;
      display: block;
      pointer-events: visible;
    }

    .zoom-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .zoom-btn {
      background: rgba(90, 190, 255, 0.2);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.5rem 1.2rem;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      min-width: 60px;
      justify-content: center;
    }

    .zoom-btn:active {
      background: rgba(90, 190, 255, 0.4);
    }

    .zoom-level {
      background: rgba(90, 190, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.5rem 1.2rem;
      color: var(--accent);
      font-size: 0.9rem;
      min-width: 80px;
      text-align: center;
    }

    /* Funktionsinfos */
    .func-info {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .chip {
      background: rgba(90, 190, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 60px;
      padding: 0.3rem 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
    }

    .chip i {
      color: var(--text-dim);
      font-weight: 400;
      margin-right: 0.3rem;
    }

    /* Rechte Seite ‚Äì untereinander */
    .exercise-area {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* QR-Code Container */
    .qr-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--border);
      text-align: center;
    }

    .qr-container h3 {
      color: var(--accent);
      margin-bottom: 0.8rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }

    .qr-code {
      width: 120px;
      height: 120px;
      margin: 0 auto;
      background: white;
      padding: 10px;
      border-radius: 20px;
    }

    .qr-code svg {
      width: 100%;
      height: 100%;
    }

    .exercise-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--border);
    }

    .exercise-title {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
      color: var(--accent);
      font-size: 1rem;
    }

    /* Mobile-optimierte Eingabefelder */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .step-row {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 0.8rem;
      border-radius: 16px;
      border-left: 3px solid var(--accent);
    }

    .step-label {
      font-weight: bold;
      color: var(--accent);
      font-size: 0.85rem;
    }

    .step-row input {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.8rem 1rem;
      color: white;
      font-size: 1rem;
      outline: none;
      width: 100%;
    }

    .step-row .step-hint {
      color: var(--text-dim);
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }

    /* Tabelle f√ºr mobile */
    .table-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 0.5rem;
      border-radius: 30px;
    }

    .table-label {
      min-width: 50px;
      font-weight: bold;
    }

    .table-row input {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.6rem 1rem;
      color: white;
      font-size: 0.95rem;
    }

    /* Buttons ‚Äì gro√ü und gut klickbar */
    .button-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 1rem 0 0.5rem;
    }

    .btn {
      background: rgba(90, 190, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 40px;
      padding: 0.8rem 1.2rem;
      color: white;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      flex: 1 1 auto;
      min-width: 120px;
    }

    .btn-primary {
      background: rgba(90, 190, 255, 0.3);
      border-color: var(--accent);
    }

    .btn-primary:active {
      background: rgba(90, 190, 255, 0.5);
      transform: scale(0.98);
    }

    .btn:active {
      background: rgba(90, 190, 255, 0.25);
      transform: scale(0.98);
    }

    /* Feedback-Bereich */
    .feedback {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 30px;
      padding: 0.8rem 1rem;
      margin-top: 1rem;
      border-left: 4px solid var(--accent);
      font-size: 0.9rem;
      color: var(--text-dim);
      word-break: break-word;
    }

    .feedback.success {
      border-left-color: var(--success);
      color: #a5e0b5;
    }

    .feedback.error {
      border-left-color: var(--error);
      color: #f5a3a3;
    }

    /* Hide desktop navigation */
    .desktop-nav {
      display: none;
    }

    /* Portrait-optimiert */
    @media (max-width: 480px) {
      .main-content {
        padding: 0.8rem 0.8rem 5rem 0.8rem;
      }
      
      .btn {
        padding: 0.7rem 1rem;
        font-size: 0.9rem;
        min-width: 100px;
      }
      
      .chip {
        font-size: 0.8rem;
      }
      
      .svg-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Mobile Navigation (unten) mit PDF-Button -->
  <div class="mobile-nav" id="mobileNav">
    <button class="nav-item active" data-section="coords">
      <span>üìå</span>
      <span>Punkte</span>
    </button>
    <button class="nav-item" data-section="table">
      <span>üìä</span>
      <span>Tabelle</span>
    </button>
    <button class="nav-item" data-section="normalform">
      <span>üìà</span>
      <span>m & b</span>
    </button>
    <button class="nav-item" data-section="parallel">
      <span>‚ö°</span>
      <span>Parallel</span>
    </button>
    <button class="nav-item" data-section="nullstellen">
      <span>‚ùå</span>
      <span>Nullstellen</span>
    </button>
    <button class="nav-item" id="pdfExportBtn">
      <span>üìÑ</span>
      <span>PDF</span>
    </button>
  </div>

  <!-- Hauptinhalt (scrollbar) -->
  <div class="main-content" id="mainContent">
    <div class="main-panel" id="mainPanel">
      <!-- Wird per JavaScript bef√ºllt -->
    </div>
  </div>
</div>

<script>
  (function() {
    // =====================================================
    // QR CODE GENERATOR
    // =====================================================
    function generateQRCode() {
      const url = window.location.href;
      // Einfacher QR-Code als SVG (f√ºr Demo-Zwecke)
      return `<svg viewBox="0 0 100 100" width="100" height="100">
        <rect width="100" height="100" fill="white"/>
        <!-- Simulierter QR-Code -->
        <rect x="10" y="10" width="15" height="15" fill="black"/>
        <rect x="30" y="10" width="15" height="15" fill="black"/>
        <rect x="50" y="10" width="15" height="15" fill="black"/>
        <rect x="70" y="10" width="15" height="15" fill="black"/>
        <rect x="10" y="30" width="15" height="15" fill="black"/>
        <rect x="30" y="30" width="15" height="15" fill="black"/>
        <rect x="50" y="30" width="15" height="15" fill="black"/>
        <rect x="70" y="30" width="15" height="15" fill="black"/>
        <rect x="10" y="50" width="15" height="15" fill="black"/>
        <rect x="30" y="50" width="15" height="15" fill="black"/>
        <rect x="50" y="50" width="15" height="15" fill="black"/>
        <rect x="70" y="50" width="15" height="15" fill="black"/>
        <rect x="10" y="70" width="15" height="15" fill="black"/>
        <rect x="30" y="70" width="15" height="15" fill="black"/>
        <rect x="50" y="70" width="15" height="15" fill="black"/>
        <rect x="70" y="70" width="15" height="15" fill="black"/>
      </svg>`;
    }

    // =====================================================
    // GLOBAL STATE
    // =====================================================
    let currentSection = 'coords';
    let currentExample = null;
    let currentLevel = 'standard';
    
    // F√ºr Zoom-Funktion
    let zoomLevel = 1;
    const MIN_ZOOM = 0.3;
    const MAX_ZOOM = 3;

    // =====================================================
    // HILFSFUNKTIONEN
    // =====================================================
    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getRange() {
      if (currentLevel === 'basic') return 4;
      if (currentLevel === 'advanced') return 10;
      return 6;
    }

    function randomSlope() {
      let m;
      const range = getRange();
      do {
        if (currentLevel === 'advanced') {
          const num = rand(-5, 5);
          const den = rand(1, 4);
          m = num / den;
        } else {
          m = rand(-range, range);
        }
      } while (Math.abs(m) < 0.001);
      return m;
    }

    function asFraction(m) {
      if (Number.isInteger(m)) return m.toString();
      const eps = 0.001;
      for (let den = 1; den <= 8; den++) {
        for (let num = -8; num <= 8; num++) {
          if (Math.abs(m - num / den) < eps) return `${num}/${den}`;
        }
      }
      return m.toFixed(2);
    }

    function computeNullstelle(m, b) {
      if (Math.abs(m) < 0.0001) return null;
      return -b / m;
    }

    // =====================================================
    // EXAMPLE GENERATION
    // =====================================================
    function generateExample(section) {
      const range = getRange();

      if (section === 'coords') {
        return {
          target: {
            x: rand(-range, range),
            y: rand(-range, range)
          }
        };
      }

      if (section === 'table') {
        const m = randomSlope();
        const b = rand(-range, range);
        const xs = [-2, -1, 0, 1, 2];
        const ys = xs.map(x => m * x + b);
        return { m, b, xs, ys };
      }

      if (section === 'normalform') {
        const m = randomSlope();
        const b = rand(-range, range);
        return { m, b };
      }

      if (section === 'parallel') {
        const m = randomSlope();
        const b = rand(-range, range);
        const P = { x: rand(-3, 3), y: rand(-3, 3) };
        const mPerp = -1 / m;
        const bPar = P.y - m * P.x;
        const bPerp = P.y - mPerp * P.x;
        return { m, b, P, mPerp, bPar, bPerp };
      }

      if (section === 'nullstellen') {
        const m = randomSlope();
        const b = rand(-range, range);
        const n = computeNullstelle(m, b);
        return { m, b, nullstelle: n };
      }
    }

    // =====================================================
    // SHUFFLE Funktion f√ºr PDF
    // =====================================================
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // =====================================================
    // PDF EXPORT (ohne Koordinatensysteme)
    // =====================================================
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Arbeitsblatt ‚Äì Lineare Funktionen", 20, 15);

      doc.setFontSize(11);
      
      let levelText = "Standard";
      if (currentLevel === 'basic') levelText = "Basis";
      if (currentLevel === 'advanced') levelText = "Erweitert";
      doc.text("Niveau: " + levelText, 20, 22);
      doc.text("Datum: ____________________", 140, 22);

      let y = 35;
      const sections = shuffle(['coords', 'table', 'normalform', 'parallel', 'nullstellen']);
      const solutions = [];

      sections.forEach((sec, i) => {
        const ex = generateExample(sec);

        doc.setFontSize(12);
        doc.text("Aufgabe " + (i + 1) + ":", 20, y);
        y += 8;

        if (sec === 'coords') {
          doc.text("Gib die Koordinaten des Punktes ein.", 25, y);
          y += 6;
          doc.text("Punkt: ( ___ | ___ )", 30, y);
          solutions.push(`(${ex.target.x}|${ex.target.y})`);
        }

        if (sec === 'table') {
          doc.text(`Vervollst√§ndige die Wertetabelle zu y = ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}.`, 25, y);
          y += 6;
          doc.text("x | -2 | -1 | 0 | 1 | 2", 30, y);
          y += 6;
          doc.text("y | __ | __ | __ | __ | __", 30, y);
          solutions.push(`m = ${asFraction(ex.m)}, b = ${ex.b}`);
        }

        if (sec === 'normalform') {
          doc.text("Bestimme m und b aus der Funktionsgleichung.", 25, y);
          y += 6;
          doc.text("m = _______, b = _______", 30, y);
          solutions.push(`m = ${asFraction(ex.m)}, b = ${ex.b}`);
        }

        if (sec === 'parallel') {
          doc.text(`Bestimme die parallele und senkrechte Gerade durch P(${ex.P.x}|${ex.P.y})`, 25, y);
          y += 6;
          doc.text("Parallel:   y = ______ x + ______", 30, y);
          y += 6;
          doc.text("Senkrecht: y = ______ x + ______", 30, y);
          solutions.push(`Parallel: y = ${asFraction(ex.m)}x ${ex.bPar >= 0 ? '+' : '-'} ${Math.abs(ex.bPar)}`);
          solutions.push(`Senkrecht: y = ${asFraction(ex.mPerp)}x ${ex.bPerp >= 0 ? '+' : '-'} ${Math.abs(ex.bPerp)}`);
        }

        if (sec === 'nullstellen') {
          doc.text(`Bestimme die Nullstelle von y = ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}.`, 25, y);
          y += 6;
          doc.text("Nullstelle: x = _______", 30, y);
          solutions.push(`x = ${asFraction(ex.nullstelle)}`);
        }

        y += 15;
        if (y > 260) {
          doc.addPage();
          y = 30;
        }
      });

      doc.addPage();
      doc.text("L√∂sungen", 20, 20);
      y = 30;

      solutions.forEach((s, i) => {
        doc.text((i + 1) + ". " + s, 20, y);
        y += 8;
      });

      doc.save("Arbeitsblatt_Lineare_Funktionen.pdf");
    }

    // =====================================================
    // KOORDINATENSYSTEM SVG
    // =====================================================
    function renderSVG(m, b, points = [], highlightPoint = null, drawTriangle = false, P = null, nullstelle = null, hideTarget = false) {
      // Bereich f√ºr das Koordinatensystem
      const xMin = -8, xMax = 8, yMin = -8, yMax = 8;
      const viewBox = `${xMin} ${-yMax} ${xMax - xMin} ${yMax - yMin}`;

      let grid = '';
      for (let x = xMin; x <= xMax; x++) {
        grid += `<line x1="${x}" y1="${-yMin}" x2="${x}" y2="${-yMax}" stroke="#2A3450" stroke-width="0.05" />`;
      }
      for (let y = yMin; y <= yMax; y++) {
        grid += `<line x1="${xMin}" y1="${-y}" x2="${xMax}" y2="${-y}" stroke="#2A3450" stroke-width="0.05" />`;
      }
      
      // Achsen mit Beschriftung
      grid += `<line x1="0" y1="${-yMin}" x2="0" y2="${-yMax}" stroke="#5ABFFF" stroke-width="0.12" />`;
      grid += `<line x1="${xMin}" y1="0" x2="${xMax}" y2="0" stroke="#5ABFFF" stroke-width="0.12" />`;
      
      // Achsenbeschriftungen
      grid += `<text x="${xMax - 0.4}" y="0.5" fill="#5ABFFF" font-size="0.5" font-weight="bold">x</text>`;
      grid += `<text x="0.4" y="${-yMax + 0.6}" fill="#5ABFFF" font-size="0.5" font-weight="bold">y</text>`;
      
      // Zahlen an den Achsen
      for (let x = -7; x <= 7; x++) {
        if (x !== 0 && Math.abs(x) <= 7) {
          grid += `<text x="${x - 0.15}" y="-0.3" fill="#A5B3D9" font-size="0.4">${x}</text>`;
        }
      }
      for (let y = -7; y <= 7; y++) {
        if (y !== 0 && Math.abs(y) <= 7) {
          grid += `<text x="0.2" y="${-y + 0.2}" fill="#A5B3D9" font-size="0.4">${y}</text>`;
        }
      }

      let pointsSvg = '';
      if (points && points.length) {
        points.forEach(p => {
          pointsSvg += `<circle cx="${p.x}" cy="${-p.y}" r="0.25" fill="#FFB347" />`;
        });
      }

      const y1 = m * xMin + b;
      const y2 = m * xMax + b;
      const line = `<line x1="${xMin}" y1="${-y1}" x2="${xMax}" y2="${-y2}" stroke="#5ABFFF" stroke-width="0.15" />`;

      let highlight = '';
      
      // Referenzpunkt (rot) wird NUR angezeigt, wenn hideTarget = false
      // In Aufgabe 1 ist hideTarget = true, also wird der rote Punkt NICHT angezeigt
      if (!hideTarget) {
        if (highlightPoint) {
          highlight += `<circle cx="${highlightPoint.x}" cy="${-highlightPoint.y}" r="0.3" fill="#EB5757" />`;
        }
      }
      
      if (P) {
        highlight += `<circle cx="${P.x}" cy="${-P.y}" r="0.3" fill="#EB5757" />`;
      }
      if (nullstelle !== null) {
        const x0 = nullstelle;
        const y0 = 0;
        if (x0 >= xMin && x0 <= xMax) {
          highlight += `<circle cx="${x0}" cy="${-y0}" r="0.35" fill="#EB5757" />`;
          highlight += `<text x="${x0 + 0.4}" y="${-0.4}" fill="#EB5757" font-size="0.5">N</text>`;
        }
      }

      let triangle = '';
      if (drawTriangle && m !== 0) {
        const run = 2;
        const rise = m * run;
        const startX = 0, startY = b;
        const endX = startX + run, endY = startY + rise;
        if (Math.abs(endX) <= 7 && Math.abs(endY) <= 7) {
          triangle = `
            <line x1="${startX}" y1="${-startY}" x2="${endX}" y2="${-startY}" stroke="#A5B3D9" stroke-width="0.1" stroke-dasharray="0.2 0.2" />
            <line x1="${endX}" y1="${-startY}" x2="${endX}" y2="${-endY}" stroke="#A5B3D9" stroke-width="0.1" stroke-dasharray="0.2 0.2" />
            <text x="${(startX + endX) / 2}" y="${-startY + 0.5}" fill="#A5B3D9" font-size="0.45">${run}</text>
            <text x="${endX + 0.4}" y="${-(startY + rise / 2)}" fill="#A5B3D9" font-size="0.45">${asFraction(m * run)}</text>
          `;
        }
      }

      return `
        <svg viewBox="${viewBox}" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
          ${grid}
          ${line}
          ${triangle}
          ${pointsSvg}
          ${highlight}
        </svg>
      `;
    }

    // =====================================================
    // ZOOM-FUNKTION
    // =====================================================
    function setupZoomableSVG(container, svgElement) {
      if (!container || !svgElement) return;
      
      // Zoom-Level zur√ºcksetzen
      zoomLevel = 1;
      
      // Container f√ºr das SVG erstellen
      const wrapper = document.createElement('div');
      wrapper.className = 'zoomable-svg';
      
      // SVG in den Wrapper verschieben
      svgElement.parentNode.insertBefore(wrapper, svgElement);
      wrapper.appendChild(svgElement);
      
      // Transform zur√ºcksetzen
      wrapper.style.transform = `scale(${zoomLevel})`;
      
      // Zoom mit Mausrad
      wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        zoomLevel *= delta;
        zoomLevel = Math.min(Math.max(zoomLevel, MIN_ZOOM), MAX_ZOOM);
        wrapper.style.transform = `scale(${zoomLevel})`;
        updateZoomDisplay();
      });
      
      // Steuerungs-Buttons
      const controls = document.createElement('div');
      controls.className = 'zoom-controls';
      controls.innerHTML = `
        <button class="zoom-btn" id="zoomOut">‚àí</button>
        <span class="zoom-level" id="zoomDisplay">100%</span>
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomReset">‚Ü∫</button>
      `;
      
      container.appendChild(controls);
      
      // Zoom-Buttons
      document.getElementById('zoomIn').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomLevel *= 1.2;
        zoomLevel = Math.min(zoomLevel, MAX_ZOOM);
        wrapper.style.transform = `scale(${zoomLevel})`;
        updateZoomDisplay();
      });
      
      document.getElementById('zoomOut').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomLevel *= 0.8;
        zoomLevel = Math.max(zoomLevel, MIN_ZOOM);
        wrapper.style.transform = `scale(${zoomLevel})`;
        updateZoomDisplay();
      });
      
      document.getElementById('zoomReset').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomLevel = 1;
        wrapper.style.transform = `scale(1)`;
        updateZoomDisplay();
      });
      
      function updateZoomDisplay() {
        const display = document.getElementById('zoomDisplay');
        if (display) {
          display.textContent = Math.round(zoomLevel * 100) + '%';
        }
      }
    }

    // =====================================================
    // KLICK-FUNKTION F√úR KOORDINATEN-√úBUNG (KORRIGIERT)
    // =====================================================
    function setupCoordsClick(svg, ex, feedback) {
      if (!svg) return;
      
      svg.style.cursor = "crosshair";
      
      // Alte Event-Listener entfernen
      if (svg._clickHandler) {
        svg.removeEventListener('click', svg._clickHandler);
      }
      
      const handleClick = (e) => {
        // Mausposition im Fenster
        const clientX = e.clientX;
        const clientY = e.clientY;
        
        // SVG-Element und seine Position
        const svgRect = svg.getBoundingClientRect();
        
        // Zoom-Level
        const zoom = zoomLevel;
        
        // Relative Position im SVG (0-1) mit Zoom-Korrektur
        const relX = (clientX - svgRect.left) / (svgRect.width / zoom);
        const relY = (clientY - svgRect.top) / (svgRect.height / zoom);
        
        // ViewBox des SVGs
        const viewBox = svg.viewBox.baseVal;
        const viewBoxWidth = viewBox.width;
        const viewBoxHeight = viewBox.height;
        
        // Absolute Koordinaten im ViewBox-System
        // WICHTIG: Die Y-Achse ist im SVG gespiegelt (negativ)
        const x = viewBox.x + relX * viewBoxWidth;
        const y = -(viewBox.y + relY * viewBoxHeight - viewBoxHeight);
        
        // Auf n√§chste ganze Zahl runden (Gitterpunkte)
        const gridX = Math.round(x);
        const gridY = Math.round(y);
        
        console.log('Klick:', {x, y, gridX, gridY, target: ex.target});
        
        // Pr√ºfen ob innerhalb des sichtbaren Bereichs
        const range = getRange() + 2;
        if (gridX >= -range && gridX <= range && gridY >= -range && gridY <= range) {
          // Alten Punkt entfernen
          const oldPoint = svg.querySelector('#user-point');
          if (oldPoint) oldPoint.remove();
          
          // Neuen Punkt zeichnen
          const point = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          point.id = "user-point";
          point.setAttribute("cx", gridX);
          point.setAttribute("cy", -gridY);
          point.setAttribute("r", "0.35");
          point.setAttribute("fill", "#FFD966");
          point.setAttribute("stroke", "white");
          point.setAttribute("stroke-width", "0.05");
          svg.appendChild(point);
          
          // Pr√ºfen ob richtig
          if (gridX === ex.target.x && gridY === ex.target.y) {
            feedback.textContent = '‚úÖ Richtig! Punkt getroffen.';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `‚ùå Falsch. Du hast (${gridX}|${gridY}) angeklickt. Gesucht: (${ex.target.x}|${ex.target.y})`;
            feedback.className = 'feedback error';
          }
        } else {
          feedback.textContent = `‚ö†Ô∏è Au√üerhalb des sichtbaren Bereichs. Zoome heraus oder w√§hle einen Punkt zwischen -${range} und ${range}.`;
          feedback.className = 'feedback';
        }
      };
      
      svg.addEventListener('click', handleClick);
      svg._clickHandler = handleClick;
    }

    // =====================================================
    // LEVEL SELECT ERSTELLEN
    // =====================================================
    function createLevelSelect() {
      const levelSelect = document.createElement("select");
      levelSelect.className = "level-select";
      levelSelect.innerHTML = `
        <option value="basic">üü¢ Basis (Zahlen -4 bis 4)</option>
        <option value="standard" selected>üü° Standard (Zahlen -6 bis 6)</option>
        <option value="advanced">üî¥ Erweitert (Zahlen -10 bis 10)</option>
      `;

      const mainContent = document.querySelector(".main-content");
      mainContent.prepend(levelSelect);

      levelSelect.addEventListener("change", (e) => {
        currentLevel = e.target.value;
        currentExample = generateExample(currentSection);
        render();
      });

      return levelSelect;
    }

    // =====================================================
    // RENDER
    // =====================================================
    function render() {
      const panel = document.getElementById('mainPanel');
      const section = currentSection;
      const ex = currentExample;

      let graphTitle = '';
      let graphSVG = '';
      let funcChips = '';

      if (section === 'coords') {
        graphTitle = 'üìç Punkt finden';
        // hideTarget = true f√ºr Aufgabe 1 - der rote Punkt wird NICHT angezeigt
        graphSVG = renderSVG(0, 0, [], ex.target, false, null, null, true);
        funcChips = `<div class="chip"><i>Gesucht:</i> (${ex.target.x} | ${ex.target.y})</div>`;
      } else if (section === 'table') {
        graphTitle = 'üìä Wertetabelle ‚Üí Graph';
        graphSVG = renderSVG(ex.m, ex.b, ex.xs.map((x, i) => ({ x, y: ex.ys[i] })));
        funcChips = `<div class="chip"><i>y =</i> ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}</div>`;
      } else if (section === 'normalform') {
        graphTitle = 'üìà Steigung & Achsenabschnitt';
        graphSVG = renderSVG(ex.m, ex.b, [], null, true);
        funcChips = `<div class="chip"><i>m =</i> ${asFraction(ex.m)}</div><div class="chip"><i>b =</i> ${ex.b}</div>`;
      } else if (section === 'parallel') {
        graphTitle = '‚ö° Parallele & Senkrechte';
        graphSVG = renderSVG(ex.m, ex.b, [], null, false, ex.P);
        funcChips = `<div class="chip"><i>m =</i> ${asFraction(ex.m)}</div><div class="chip"><i>P =</i> (${ex.P.x}|${ex.P.y})</div>`;
      } else {
        graphTitle = '‚ùå Nullstellen berechnen';
        graphSVG = renderSVG(ex.m, ex.b, [], null, false, null, ex.nullstelle);
        funcChips = `<div class="chip"><i>f(x) =</i> ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}</div>`;
      }

      let exerciseHTML = '';

      if (section === 'coords') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>üéØ</span> Klick-√úbung</div>
            <div class="input-group">
              <div class="step-row">
                <span class="step-label">Klicke direkt auf den gesuchten Punkt im Koordinatensystem</span>
                <span class="step-hint">Der rote Punkt dient als Referenz und wird nicht angezeigt</span>
                <span class="step-hint">Bei Bedarf kannst du mit den Buttons zoomen</span>
              </div>
            </div>
            <div class="button-group">
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="coordsFeedback">Klicke auf den Punkt (${ex.target.x}|${ex.target.y}).</div>
          </div>
        `;
      } else if (section === 'table') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>üìù</span> Tabelle</div>
            <div class="input-group">
              ${ex.xs.map((x, idx) => `
                <div class="table-row">
                  <span class="table-label">x=${x}</span>
                  <input type="text" id="tableInput${idx}" placeholder="y">
                </div>
              `).join('')}
            </div>
            <div class="button-group">
              <button class="btn" id="tableCheckBtn">‚úÖ Pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="tableFeedback">Trage die y-Werte ein.</div>
          </div>
        `;
      } else if (section === 'normalform') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>üìê</span> m & b bestimmen</div>
            <div class="input-group">
              <input type="text" id="normalM" placeholder="Steigung m (z.B. 2 oder 3/4)">
              <input type="text" id="normalB" placeholder="Achsenabschnitt b">
            </div>
            <div class="button-group">
              <button class="btn" id="normalCheckBtn">üîç Pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="normalFeedback">Lies m und b aus dem Graphen ab.</div>
          </div>
        `;
      } else if (section === 'parallel') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>‚ö°</span> Parallele Geraden Schritt f√ºr Schritt</div>
            <div class="input-group">
              <div class="step-row">
                <span class="step-label">1Ô∏è‚É£ Steigung f√ºr Parallele</span>
                <input type="text" id="parallelStep1" placeholder="m‚à• = ? (gleiche Steigung)">
                <span class="step-hint">Parallele haben gleiche Steigung m = ${asFraction(ex.m)}</span>
              </div>
              <div class="step-row">
                <span class="step-label">2Ô∏è‚É£ b der Parallelen berechnen</span>
                <input type="text" id="parallelStep2" placeholder="b‚à• = y - m¬∑x">
                <span class="step-hint">Punkt P (${ex.P.x}|${ex.P.y}) einsetzen</span>
              </div>
              <div class="step-row">
                <span class="step-label">3Ô∏è‚É£ Senkrechte: Steigung m‚ä•</span>
                <input type="text" id="parallelStep3" placeholder="m‚ä• = -1/m">
                <span class="step-hint">m‚ä• = -1 / ${asFraction(ex.m)}</span>
              </div>
              <div class="step-row">
                <span class="step-label">4Ô∏è‚É£ b der Senkrechten berechnen</span>
                <input type="text" id="parallelStep4" placeholder="b‚ä• = y - m‚ä•¬∑x">
                <span class="step-hint">Punkt P (${ex.P.x}|${ex.P.y}) einsetzen</span>
              </div>
            </div>
            <div class="button-group">
              <button class="btn" id="parallelStepCheckBtn">üîç Schritte pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="parallelStepFeedback">F√ºlle jeden Schritt nacheinander aus.</div>
          </div>
        `;
      } else {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>‚ùå</span> Nullstellen Schritt f√ºr Schritt</div>
            <div class="input-group">
              <div class="step-row">
                <span class="step-label">1Ô∏è‚É£ f(x) = 0 setzen</span>
                <input type="text" id="step1" placeholder="z.B. 0 oder f(x)=0">
              </div>
              <div class="step-row">
                <span class="step-label">2Ô∏è‚É£ Funktion einsetzen</span>
                <input type="text" id="step2" placeholder="mx + b = 0">
              </div>
              <div class="step-row">
                <span class="step-label">3Ô∏è‚É£ b auf andere Seite</span>
                <input type="text" id="step3" placeholder="mx = -b">
              </div>
              <div class="step-row">
                <span class="step-label">4Ô∏è‚É£ Durch m dividieren</span>
                <input type="text" id="step4" placeholder="x = -b/m">
              </div>
              <div class="step-row">
                <span class="step-label">5Ô∏è‚É£ Nullstelle</span>
                <input type="text" id="step5" placeholder="x = ...">
              </div>
            </div>
            <div class="button-group">
              <button class="btn" id="nullstellenCheckBtn">üîç Schritte pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="nullstellenFeedback">F√ºlle jeden Schritt aus.</div>
          </div>
        `;
      }

      panel.innerHTML = `
        <div class="graph-area">
          <div class="graph-title">
            <span>${graphTitle}</span>
          </div>
          <div class="svg-container" id="svgContainer">
            ${graphSVG}
          </div>
          <div class="func-info">
            ${funcChips}
          </div>
        </div>
        <div class="exercise-area">
          <div class="qr-container">
            <h3><span>üì±</span> QR-Code</h3>
            <div class="qr-code">
              ${generateQRCode()}
            </div>
          </div>
          ${exerciseHTML}
        </div>
      `;

      // Mobile Navigation aktiv setzen
      document.querySelectorAll('.nav-item:not(#pdfExportBtn)').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === currentSection) btn.classList.add('active');
      });

      // SVG zoomf√§hig machen
      const container = document.getElementById('svgContainer');
      const svg = container.querySelector('svg');
      if (svg) {
        setupZoomableSVG(container, svg);
      }

      // Event-Listener f√ºr "Neu" Buttons
      document.querySelectorAll('#newExampleBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentExample = generateExample(currentSection);
          render();
        });
      });

      // Navigation-Buttons
      document.querySelectorAll('.nav-item[data-section]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentSection = e.currentTarget.dataset.section;
          currentExample = generateExample(currentSection);
          render();
        });
      });

      // Abschnitts-spezifische Pr√ºfungen
      if (section === 'coords') {
        const svg = document.querySelector('#svgContainer svg');
        const feedback = document.getElementById('coordsFeedback');
        if (svg && feedback) {
          setupCoordsClick(svg, ex, feedback);
        }
      }

      if (section === 'table') {
        const checkBtn = document.getElementById('tableCheckBtn');
        const feedback = document.getElementById('tableFeedback');
        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            let allCorrect = true;
            for (let i = 0; i < ex.xs.length; i++) {
              const inp = document.getElementById(`tableInput${i}`);
              if (inp) {
                const val = parseFloat(inp.value.replace(',', '.'));
                if (isNaN(val) || Math.abs(val - ex.ys[i]) > 0.01) {
                  allCorrect = false;
                  inp.style.borderColor = '#EB5757';
                } else {
                  inp.style.borderColor = '#6FCF97';
                }
              }
            }
            if (allCorrect) {
              feedback.textContent = '‚úÖ Tabelle richtig!';
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = '‚ùå Nicht alle Werte stimmen.';
              feedback.className = 'feedback error';
            }
          });
        }
      }

      if (section === 'normalform') {
        const checkBtn = document.getElementById('normalCheckBtn');
        const mInp = document.getElementById('normalM');
        const bInp = document.getElementById('normalB');
        const feedback = document.getElementById('normalFeedback');
        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const mVal = parseFloat(mInp.value.replace(',', '.'));
            const bVal = parseFloat(bInp.value.replace(',', '.'));
            if (!isNaN(mVal) && !isNaN(bVal) && Math.abs(mVal - ex.m) < 0.01 && Math.abs(bVal - ex.b) < 0.01) {
              feedback.textContent = `‚úÖ Korrekt! m = ${asFraction(ex.m)}, b = ${ex.b}`;
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = `‚ùå Falsch. Tipp: m = ${asFraction(ex.m)}, b = ${ex.b}`;
              feedback.className = 'feedback error';
            }
          });
        }
      }

      if (section === 'parallel') {
        const checkBtn = document.getElementById('parallelStepCheckBtn');
        const feedback = document.getElementById('parallelStepFeedback');
        const step1 = document.getElementById('parallelStep1');
        const step2 = document.getElementById('parallelStep2');
        const step3 = document.getElementById('parallelStep3');
        const step4 = document.getElementById('parallelStep4');

        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const expected1 = asFraction(ex.m);
            const expected2 = asFraction(ex.bPar);
            const expected3 = asFraction(ex.mPerp);
            const expected4 = asFraction(ex.bPerp);

            const val1 = step1.value.trim().replace(/\s+/g, '');
            const val2 = step2.value.trim().replace(/\s+/g, '');
            const val3 = step3.value.trim().replace(/\s+/g, '');
            const val4 = step4.value.trim().replace(/\s+/g, '');

            const step1OK = val1 === expected1 || val1 === ex.m.toString() || Math.abs(parseFloat(val1) - ex.m) < 0.01;
            const step2OK = val2 === expected2 || val2 === ex.bPar.toString() || Math.abs(parseFloat(val2) - ex.bPar) < 0.01;
            const step3OK = val3 === expected3 || val3 === ex.mPerp.toString() || Math.abs(parseFloat(val3) - ex.mPerp) < 0.01;
            const step4OK = val4 === expected4 || val4 === ex.bPerp.toString() || Math.abs(parseFloat(val4) - ex.bPerp) < 0.01;

            step1.style.borderColor = step1OK ? '#6FCF97' : '#EB5757';
            step2.style.borderColor = step2OK ? '#6FCF97' : '#EB5757';
            step3.style.borderColor = step3OK ? '#6FCF97' : '#EB5757';
            step4.style.borderColor = step4OK ? '#6FCF97' : '#EB5757';

            if (step1OK && step2OK && step3OK && step4OK) {
              feedback.textContent = `‚úÖ Alle Schritte korrekt!`;
              feedback.className = 'feedback success';
            } else {
              const wrongSteps = [];
              if (!step1OK) wrongSteps.push('1');
              if (!step2OK) wrongSteps.push('2');
              if (!step3OK) wrongSteps.push('3');
              if (!step4OK) wrongSteps.push('4');
              feedback.textContent = `‚ùå Schritt(e) ${wrongSteps.join(', ')} nicht korrekt.`;
              feedback.className = 'feedback error';
            }
          });
        }
      }

      if (section === 'nullstellen') {
        const checkBtn = document.getElementById('nullstellenCheckBtn');
        const feedback = document.getElementById('nullstellenFeedback');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');

        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const expected1 = '0';
            const expected2 = `${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)} = 0`;
            const expected3 = `${asFraction(ex.m)}x = ${-ex.b}`;
            const expected4 = `x = ${asFraction(-ex.b)} / ${asFraction(ex.m)}`;
            const expected5 = ex.nullstelle !== null ? `x = ${ex.nullstelle.toFixed(2)}` : 'keine Nullstelle';

            const val1 = step1.value.trim();
            const step1OK = val1 === '0' || val1 === 'f(x)=0' || val1 === 'f(x) = 0';
            
            const val2 = step2.value.trim().replace(/\s+/g, '');
            const expected2clean = expected2.replace(/\s+/g, '');
            const step2OK = val2 === expected2clean || (val2.includes(`${asFraction(ex.m)}x`) && val2.includes('=0'));
            
            const val3 = step3.value.trim().replace(/\s+/g, '');
            const expected3clean = expected3.replace(/\s+/g, '');
            const step3OK = val3 === expected3clean || (val3.includes(`${asFraction(ex.m)}x=`) && val3.includes(`${-ex.b}`));
            
            const val4 = step4.value.trim().replace(/\s+/g, '');
            const expected4clean = expected4.replace(/\s+/g, '');
            const step4OK = val4 === expected4clean || (val4.includes('x=') && val4.includes('/'));
            
            const val5 = step5.value.trim();
            let step5OK = false;
            if (ex.nullstelle !== null) {
              step5OK = val5.includes(ex.nullstelle.toFixed(2)) || val5.includes(asFraction(ex.nullstelle));
            } else {
              step5OK = val5.toLowerCase().includes('keine') || val5.includes('unendlich');
            }

            step1.style.borderColor = step1OK ? '#6FCF97' : '#EB5757';
            step2.style.borderColor = step2OK ? '#6FCF97' : '#EB5757';
            step3.style.borderColor = step3OK ? '#6FCF97' : '#EB5757';
            step4.style.borderColor = step4OK ? '#6FCF97' : '#EB5757';
            step5.style.borderColor = step5OK ? '#6FCF97' : '#EB5757';

            if (step1OK && step2OK && step3OK && step4OK && step5OK) {
              feedback.textContent = `‚úÖ Alle Schritte korrekt!`;
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = `‚ùå Einige Schritte nicht korrekt.`;
              feedback.className = 'feedback error';
            }
          });
        }
      }
    }

    // =====================================================
    // INITIALISIERUNG
    // =====================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Level-Auswahl erstellen
      createLevelSelect();

      // PDF-Button Event-Listener
      const pdfBtn = document.getElementById('pdfExportBtn');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', (e) => {
          e.preventDefault();
          exportPDF();
        });
      }

      // Initiales Beispiel generieren
      currentExample = generateExample(currentSection);
      
      // Ersten Render durchf√ºhren
      render();
    });
  })();
</script>
</body>
</html>
