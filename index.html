<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>üìê Lineare Funktionen ‚Ä¢ mobil mit PDF</title>
  <!-- jsPDF f√ºr PDF-Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QR-Code Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0c0f1c;
      --card-bg: rgba(25, 30, 45, 0.95);
      --border: rgba(90, 190, 255, 0.2);
      --accent: #5abfff;
      --accent-glow: rgba(90, 190, 255, 0.3);
      --text: #f0f4ff;
      --text-dim: #a5b3d9;
      --success: #6fcf97;
      --error: #eb5757;
      --radius: 24px;
      --radius-sm: 16px;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      margin: 0;
    }

    /* Hauptcontainer ‚Äì vollfl√§chig f√ºr mobile */
    .app {
      width: 100%;
      min-height: 100vh;
      background: rgba(15, 20, 30, 0.9);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
    }

    /* App-Header mit Titel */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(10, 15, 25, 0.97);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      z-index: 101;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    .app-title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1rem 0.3rem 1rem;
    }

    .app-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.02em;
    }

    .qr-btn {
      background: rgba(90, 190, 255, 0.15);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.3rem 0.7rem;
      color: var(--accent);
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .qr-btn:active { background: rgba(90, 190, 255, 0.3); }

    /* QR-Modal */
    .qr-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .qr-modal.open { display: flex; }
    .qr-modal-inner {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      text-align: center;
      max-width: 90vw;
    }
    .qr-modal-inner h3 { color: var(--accent); margin-bottom: 1rem; font-size: 1rem; }
    .qr-modal-inner canvas { border-radius: 12px; background: white; padding: 8px; }
    .qr-url { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.8rem; word-break: break-all; }
    .qr-close {
      margin-top: 1rem;
      background: rgba(90,190,255,0.2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.5rem 1.5rem;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /* Mobile Navigation ‚Äì oben unter dem Titel */
    .mobile-nav {
      display: flex;
      justify-content: space-around;
      padding: 0.3rem 0.25rem 0.5rem 0.25rem;
      border-top: 1px solid rgba(90,190,255,0.08);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 0.7rem;
      padding: 0.4rem 0.1rem;
      border-radius: 12px;
      transition: all 0.2s;
      gap: 0.2rem;
    }

    .nav-item span {
      font-size: 1.3rem;
    }

    .nav-item.active {
      color: var(--accent);
      background: rgba(90, 190, 255, 0.15);
    }

    /* PDF-Button etwas hervorheben */
    #pdfExportBtn {
      color: #ffd966;
    }
    #pdfExportBtn.active {
      color: #ffd966;
      background: rgba(255, 217, 102, 0.15);
    }

    /* Level-Auswahl */
    .level-select {
      margin: 0 0 1rem 0;
      padding: 0.5rem;
      background: var(--card-bg);
      border-radius: 40px;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 1rem;
      width: 100%;
      max-width: 300px;
    }

    /* Hauptinhalt ‚Äì mit Padding oben f√ºr fixed Header */
    .main-content {
      flex: 1;
      padding: 1rem 1rem 1.5rem 1rem;
      overflow-y: auto;
      margin-top: var(--header-height, 120px);
    }

    /* Hauptbereich ‚Äì vertikale Anordnung f√ºr mobile */
    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Graph-Bereich */
    .graph-area {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .graph-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
      color: var(--accent);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .graph-title span {
      background: rgba(90, 190, 255, 0.15);
      padding: 0.2rem 0.8rem;
      border-radius: 40px;
      border: 1px solid var(--border);
    }

    .svg-container {
      background: #0b0f1a;
      border-radius: var(--radius-sm);
      padding: 0.3rem;
      border: 1px solid var(--border);
      margin-bottom: 1rem;
      overflow: hidden;
      position: relative;
      width: 100%;
      height: 300px;
      cursor: crosshair;
    }

    .zoomable-svg {
      width: 100%;
      height: 100%;
      transition: transform 0.1s ease;
      transform-origin: 0 0;
    }

    .zoomable-svg svg {
      width: 100%;
      height: 100%;
      display: block;
      pointer-events: visible;
    }

    .zoom-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .zoom-btn {
      background: rgba(90, 190, 255, 0.2);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.5rem 1.2rem;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      min-width: 60px;
      justify-content: center;
    }

    .zoom-btn:active {
      background: rgba(90, 190, 255, 0.4);
    }

    .zoom-level {
      background: rgba(90, 190, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.5rem 1.2rem;
      color: var(--accent);
      font-size: 0.9rem;
      min-width: 80px;
      text-align: center;
    }

    /* Funktionsinfos */
    .func-info {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .chip {
      background: rgba(90, 190, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 60px;
      padding: 0.3rem 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
    }

    .chip i {
      color: var(--text-dim);
      font-weight: 400;
      margin-right: 0.3rem;
    }

    /* Rechte Seite ‚Äì untereinander */
    .exercise-area {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .exercise-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--border);
    }

    .exercise-title {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
      color: var(--accent);
      font-size: 1rem;
    }

    /* Mobile-optimierte Eingabefelder */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .step-row {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 0.8rem;
      border-radius: 16px;
      border-left: 3px solid var(--accent);
    }

    .step-label {
      font-weight: bold;
      color: var(--accent);
      font-size: 0.85rem;
    }

    .step-row input {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.8rem 1rem;
      color: white;
      font-size: 1rem;
      outline: none;
      width: 100%;
    }

    .step-row .step-hint {
      color: var(--text-dim);
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }

    /* Tabelle f√ºr mobile */
    .table-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 0.5rem;
      border-radius: 30px;
    }

    .table-label {
      min-width: 50px;
      font-weight: bold;
    }

    .table-row input {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 0.6rem 1rem;
      color: white;
      font-size: 0.95rem;
    }

    /* Buttons ‚Äì gro√ü und gut klickbar */
    .button-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 1rem 0 0.5rem;
    }

    .btn {
      background: rgba(90, 190, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 40px;
      padding: 0.8rem 1.2rem;
      color: white;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      flex: 1 1 auto;
      min-width: 120px;
    }

    .btn-primary {
      background: rgba(90, 190, 255, 0.3);
      border-color: var(--accent);
    }

    .btn-primary:active {
      background: rgba(90, 190, 255, 0.5);
      transform: scale(0.98);
    }

    .btn:active {
      background: rgba(90, 190, 255, 0.25);
      transform: scale(0.98);
    }

    /* Feedback-Bereich */
    .feedback {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 30px;
      padding: 0.8rem 1rem;
      margin-top: 1rem;
      border-left: 4px solid var(--accent);
      font-size: 0.9rem;
      color: var(--text-dim);
      word-break: break-word;
    }

    .feedback.success {
      border-left-color: var(--success);
      color: #a5e0b5;
    }

    .feedback.error {
      border-left-color: var(--error);
      color: #f5a3a3;
    }

    /* Hide desktop navigation */
    .desktop-nav {
      display: none;
    }

    /* Portrait-optimiert */
    @media (max-width: 480px) {
      .main-content {
        padding: 0.8rem 0.8rem 1.5rem 0.8rem;
      }
      
      .btn {
        padding: 0.7rem 1rem;
        font-size: 0.9rem;
        min-width: 100px;
      }
      
      .chip {
        font-size: 0.8rem;
      }
      
      .svg-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
<!-- QR-Code-Modal -->
<div class="qr-modal" id="qrModal">
  <div class="qr-modal-inner">
    <h3>üì± QR-Code zur App</h3>
    <canvas id="qrCanvas"></canvas>
    <div class="qr-url" id="qrUrl"></div>
    <button class="qr-close" id="qrClose">‚úï Schlie√üen</button>
  </div>
</div>

<div class="app">
  <!-- Fixer Header: Titel + Navigation -->
  <div class="app-header" id="appHeader">
    <div class="app-title-bar">
      <div class="app-title">üìê Lineare Funktionen</div>
      <button class="qr-btn" id="qrBtn">üì± QR</button>
    </div>
    <div class="mobile-nav" id="mobileNav">
      <button class="nav-item active" data-section="coords">
        <span>üìå</span>
        <span>Punkte</span>
      </button>
      <button class="nav-item" data-section="table">
        <span>üìä</span>
        <span>Tabelle</span>
      </button>
      <button class="nav-item" data-section="normalform">
        <span>üìà</span>
        <span>m &amp; b</span>
      </button>
      <button class="nav-item" data-section="parallel">
        <span>‚ö°</span>
        <span>Parallel</span>
      </button>
      <button class="nav-item" data-section="nullstellen">
        <span>‚ùå</span>
        <span>Nullstellen</span>
      </button>
      <button class="nav-item" id="pdfExportBtn">
        <span>üìÑ</span>
        <span>PDF</span>
      </button>
    </div>
  </div>

  <!-- Hauptinhalt (scrollbar) -->
  <div class="main-content" id="mainContent">
    <div class="main-panel" id="mainPanel">
      <!-- Wird per JavaScript bef√ºllt -->
    </div>
  </div>
</div>

<script>
  (function() {
    // =====================================================
    // QR CODE GENERATOR (ENTFERNT)
    // =====================================================
    // QR-Code wurde komplett entfernt

    // =====================================================
    // GLOBAL STATE
    // =====================================================
    let currentSection = 'coords';
    let currentExample = null;
    let currentLevel = 'standard';
    
    // F√ºr Zoom-Funktion
    let zoomLevel = 1;
    const MIN_ZOOM = 0.3;
    const MAX_ZOOM = 3;

    // =====================================================
    // HILFSFUNKTIONEN
    // =====================================================
    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getRange() {
      if (currentLevel === 'basic') return 4;
      if (currentLevel === 'advanced') return 10;
      return 6;
    }

    function randomSlope() {
      let m;
      const range = getRange();
      do {
        if (currentLevel === 'advanced') {
          const num = rand(-5, 5);
          const den = rand(1, 4);
          m = num / den;
        } else {
          m = rand(-range, range);
        }
      } while (Math.abs(m) < 0.001);
      return m;
    }

    function asFraction(m) {
      if (Number.isInteger(m)) return m.toString();
      const eps = 0.001;
      for (let den = 1; den <= 8; den++) {
        for (let num = -8; num <= 8; num++) {
          if (Math.abs(m - num / den) < eps) return `${num}/${den}`;
        }
      }
      return m.toFixed(2);
    }

    function computeNullstelle(m, b) {
      if (Math.abs(m) < 0.0001) return null;
      return -b / m;
    }

    // =====================================================
    // EXAMPLE GENERATION
    // =====================================================
    function generateExample(section) {
      const range = getRange();

      if (section === 'coords') {
        // Limit to -7..7 so it's always visible in the SVG
        const visibleRange = Math.min(range, 7);
        return {
          target: {
            x: rand(-visibleRange, visibleRange),
            y: rand(-visibleRange, visibleRange)
          }
        };
      }

      if (section === 'table') {
        const m = randomSlope();
        const b = rand(-range, range);
        const xs = [-2, -1, 0, 1, 2];
        const ys = xs.map(x => m * x + b);
        return { m, b, xs, ys };
      }

      if (section === 'normalform') {
        let m, b;
        // Ensure the graph passes through the visible area well
        // b should be limited so the line is visible near center
        const bRange = Math.min(range, 5);
        do {
          m = randomSlope();
          b = rand(-bRange, bRange);
        } while (Math.abs(m * 0 + b) > 6); // y-intercept must be visible
        return { m, b };
      }

      if (section === 'parallel') {
        const m = randomSlope();
        const b = rand(-range, range);
        const P = { x: rand(-3, 3), y: rand(-3, 3) };
        const mPerp = -1 / m;
        const bPar = P.y - m * P.x;
        const bPerp = P.y - mPerp * P.x;
        return { m, b, P, mPerp, bPar, bPerp };
      }

      if (section === 'nullstellen') {
        const m = randomSlope();
        const b = rand(-range, range);
        const n = computeNullstelle(m, b);
        return { m, b, nullstelle: n };
      }
    }

    // =====================================================
    // SHUFFLE Funktion f√ºr PDF
    // =====================================================
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // =====================================================
    // PDF EXPORT ‚Äì mit Koordinatensystemen
    // =====================================================

    // Zeichnet ein Koordinatensystem in jsPDF
    function drawCoordSystem(doc, ox, oy, size, ex, sec) {
      const S = size / 16; // Skalierung: 16 Einheiten (-8..8) auf 'size' mm
      const cx = ox + size / 2; // Ursprung x in mm
      const cy = oy + size / 2; // Ursprung y in mm

      // Hintergrund
      doc.setFillColor(240, 244, 255);
      doc.rect(ox, oy, size, size, 'F');
      doc.setDrawColor(200, 210, 230);
      doc.setLineWidth(0.1);

      // Gitterlinien
      for (let i = -8; i <= 8; i++) {
        const px = cx + i * S;
        const py = cy + i * S;
        doc.setDrawColor(200, 210, 230);
        doc.setLineWidth(0.1);
        doc.line(px, oy, px, oy + size);
        doc.line(ox, py, ox + size, py);
      }

      // Achsen
      doc.setDrawColor(80, 120, 200);
      doc.setLineWidth(0.35);
      doc.line(ox, cy, ox + size, cy); // x-Achse
      doc.line(cx, oy, cx, oy + size); // y-Achse

      // Achsenbeschriftung
      doc.setFontSize(5);
      doc.setTextColor(80, 120, 200);
      doc.text('x', ox + size - 1.5, cy - 0.8);
      doc.text('y', cx + 0.8, oy + 2);

      // Zahlenbeschriftung
      doc.setFontSize(3.5);
      doc.setTextColor(100, 120, 160);
      for (let i = -7; i <= 7; i++) {
        if (i !== 0) {
          doc.text(String(i), cx + i * S - (i < 0 ? 2.2 : 0.8), cy - 0.8);
          doc.text(String(-i), cx + 0.8, cy + i * S + 1);
        }
      }

      // Funktion zeichnen (Linie von x=-8 bis x=8)
      if (sec !== 'coords') {
        const m = ex.m, b = ex.b;
        const x1 = -8, y1 = m * x1 + b;
        const x2 = 8, y2 = m * x2 + b;
        const px1 = cx + x1 * S, py1 = cy - y1 * S;
        const px2 = cx + x2 * S, py2 = cy - y2 * S;
        doc.setDrawColor(90, 150, 220);
        doc.setLineWidth(0.5);
        // Clip zur Systemgrenze
        doc.line(
          Math.max(ox, Math.min(ox + size, px1)),
          Math.max(oy, Math.min(oy + size, py1)),
          Math.max(ox, Math.min(ox + size, px2)),
          Math.max(oy, Math.min(oy + size, py2))
        );
      }

      // Punkt einzeichnen
      if (sec === 'coords') {
        const px = cx + ex.target.x * S;
        const py = cy - ex.target.y * S;
        doc.setFillColor(220, 60, 60);
        doc.circle(px, py, 1.2, 'F');
      }

      // Nullstelle
      if (sec === 'nullstellen' && ex.nullstelle !== null && Math.abs(ex.nullstelle) <= 8) {
        const px = cx + ex.nullstelle * S;
        doc.setFillColor(220, 60, 60);
        doc.circle(px, cy, 1.2, 'F');
        doc.setFontSize(4);
        doc.setTextColor(220, 60, 60);
        doc.text('N', px + 1.2, cy - 1);
      }

      // Steigungsdreieck bei normalform
      if (sec === 'normalform' && Math.abs(ex.b) <= 6.5) {
        const m = ex.m;
        const startX = 0, startY = ex.b;
        const run = Math.abs(m * 2 + ex.b) <= 6.5 ? 2 : 1;
        const endX = startX + run, endY = startY + m * run;
        if (Math.abs(endY) <= 7) {
          const sx = cx + startX * S, sy = cy - startY * S;
          const ex2 = cx + endX * S, ey = cy - endY * S;
          doc.setDrawColor(255, 140, 50);
          doc.setLineWidth(0.35);
          doc.line(sx, sy, ex2, sy);
          doc.line(ex2, sy, ex2, ey);
          doc.setFontSize(4);
          doc.setTextColor(255, 140, 50);
          doc.text(String(run), (sx + ex2) / 2 - 1, sy + 2.5);
          doc.text(asFraction(m * run), ex2 + 1, (sy + ey) / 2 + 1);
        }
      }

      // Punkt P bei parallel
      if (sec === 'parallel' && ex.P) {
        const px = cx + ex.P.x * S;
        const py = cy - ex.P.y * S;
        doc.setFillColor(220, 60, 60);
        doc.circle(px, py, 1.2, 'F');
        doc.setFontSize(4);
        doc.setTextColor(220, 60, 60);
        doc.text(`P(${ex.P.x}|${ex.P.y})`, px + 1.5, py - 1);
      }

      // Rahmen
      doc.setDrawColor(150, 180, 220);
      doc.setLineWidth(0.3);
      doc.rect(ox, oy, size, size);

      // Farben zur√ºcksetzen
      doc.setTextColor(0, 0, 0);
      doc.setDrawColor(0, 0, 0);
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Arbeitsblatt ‚Äì Lineare Funktionen", 20, 15);

      doc.setFontSize(11);
      let levelText = "Standard";
      if (currentLevel === 'basic') levelText = "Basis";
      if (currentLevel === 'advanced') levelText = "Erweitert";
      doc.text("Niveau: " + levelText, 20, 22);
      doc.text("Datum: ____________________", 130, 22);

      let y = 32;
      const sections = shuffle(['coords', 'table', 'normalform', 'parallel', 'nullstellen']);
      const solutions = [];

      sections.forEach((sec, i) => {
        const ex = generateExample(sec);

        // Neues Seite falls n√∂tig
        if (y > 220) { doc.addPage(); y = 20; }

        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text("Aufgabe " + (i + 1) + ":", 15, y);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        y += 7;

        // Aufgabentext links, Koordinatensystem rechts
        const csSize = 55; // mm
        const csX = 145;   // rechts auf Seite
        const textX = 15;
        const textMaxW = 125;

        if (sec === 'coords') {
          doc.text(`Klicke auf den Punkt (${ex.target.x}|${ex.target.y}) im Koordinatensystem.`, textX, y, { maxWidth: textMaxW });
          y += 6;
          doc.text("Der gesuchte Punkt ist rot markiert.", textX, y, { maxWidth: textMaxW });
          drawCoordSystem(doc, csX, y - 10, csSize, ex, sec);
          solutions.push(`Aufgabe ${i+1}: Punkt (${ex.target.x}|${ex.target.y})`);
          y += csSize - 5;
        }

        if (sec === 'table') {
          doc.text(`Vervollst√§ndige die Wertetabelle zu:`, textX, y, { maxWidth: textMaxW });
          y += 5;
          doc.text(`f(x) = ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}`, textX + 5, y);
          drawCoordSystem(doc, csX, y - 10, csSize, ex, sec);
          y += 6;
          doc.text("x  | -2 | -1 |  0 |  1 |  2", textX + 5, y);
          y += 5;
          doc.text("y  | __ | __ | __ | __ | __", textX + 5, y);
          solutions.push(`Aufgabe ${i+1}: y-Werte: ${ex.ys.map(v => Number.isInteger(v) ? v : v.toFixed(2)).join(' | ')}`);
          y += csSize - 15;
        }

        if (sec === 'normalform') {
          doc.text("Bestimme Steigung m und Achsenabschnitt b", textX, y, { maxWidth: textMaxW });
          y += 5;
          doc.text("aus dem abgebildeten Graphen:", textX, y, { maxWidth: textMaxW });
          drawCoordSystem(doc, csX, y - 10, csSize, ex, sec);
          y += 6;
          doc.text("m = _______     b = _______", textX + 5, y);
          solutions.push(`Aufgabe ${i+1}: m = ${asFraction(ex.m)}, b = ${ex.b}`);
          y += csSize - 15;
        }

        if (sec === 'parallel') {
          doc.text(`Bestimme Parallele und Senkrechte durch P(${ex.P.x}|${ex.P.y})`, textX, y, { maxWidth: textMaxW });
          y += 5;
          doc.text(`zur Geraden f(x) = ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}:`, textX, y);
          drawCoordSystem(doc, csX, y - 10, csSize, ex, sec);
          y += 6;
          doc.text("Parallel:   y = ______ ¬∑ x + ______", textX + 5, y);
          y += 5;
          doc.text("Senkrecht: y = ______ ¬∑ x + ______", textX + 5, y);
          solutions.push(`Aufgabe ${i+1}: Parallel: y = ${asFraction(ex.m)}x ${ex.bPar >= 0 ? '+' : '-'} ${Math.abs(ex.bPar)}`);
          solutions.push(`           Senkrecht: y = ${asFraction(ex.mPerp)}x ${ex.bPerp >= 0 ? '+' : '-'} ${Math.abs(ex.bPerp)}`);
          y += csSize - 15;
        }

        if (sec === 'nullstellen') {
          doc.text(`Bestimme die Nullstelle von:`, textX, y, { maxWidth: textMaxW });
          y += 5;
          doc.text(`f(x) = ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}`, textX + 5, y);
          drawCoordSystem(doc, csX, y - 10, csSize, ex, sec);
          y += 6;
          doc.text("Rechenweg:", textX + 5, y); y += 5;
          doc.text("0 = ________________________", textX + 5, y); y += 5;
          doc.text("x = ________________________", textX + 5, y);
          solutions.push(`Aufgabe ${i+1}: Nullstelle x = ${ex.nullstelle !== null ? asFraction(ex.nullstelle) : 'keine'}`);
          y += csSize - 20;
        }

        y += 8;
        // Trennlinie
        if (i < sections.length - 1) {
          doc.setDrawColor(200, 210, 230);
          doc.setLineWidth(0.2);
          doc.line(15, y - 4, 195, y - 4);
        }
      });

      // L√∂sungsseite
      doc.addPage();
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text("L√∂sungen", 15, 20);
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      y = 30;
      solutions.forEach((s) => {
        doc.text(s, 15, y);
        y += 7;
      });

      doc.save("Arbeitsblatt_Lineare_Funktionen.pdf");
    }

    // =====================================================
    // KOORDINATENSYSTEM SVG
    // =====================================================
    function renderSVG(m, b, points = [], highlightPoint = null, drawTriangle = false, P = null, nullstelle = null, hideTarget = false) {
      const xMin = -8, xMax = 8, yMin = -8, yMax = 8;
      const viewBox = `${xMin} ${-yMax} ${xMax - xMin} ${yMax - yMin}`;

      let grid = '';
      for (let x = xMin; x <= xMax; x++) {
        grid += `<line x1="${x}" y1="${-yMin}" x2="${x}" y2="${-yMax}" stroke="#2A3450" stroke-width="0.05" />`;
      }
      for (let y = yMin; y <= yMax; y++) {
        grid += `<line x1="${xMin}" y1="${-y}" x2="${xMax}" y2="${-y}" stroke="#2A3450" stroke-width="0.05" />`;
      }
      
      grid += `<line x1="0" y1="${-yMin}" x2="0" y2="${-yMax}" stroke="#5ABFFF" stroke-width="0.12" />`;
      grid += `<line x1="${xMin}" y1="0" x2="${xMax}" y2="0" stroke="#5ABFFF" stroke-width="0.12" />`;
      
      grid += `<text x="${xMax - 0.4}" y="0.5" fill="#5ABFFF" font-size="0.5" font-weight="bold">x</text>`;
      grid += `<text x="0.4" y="${-yMax + 0.6}" fill="#5ABFFF" font-size="0.5" font-weight="bold">y</text>`;
      
      for (let x = -7; x <= 7; x++) {
        if (x !== 0 && Math.abs(x) <= 7) {
          grid += `<text x="${x - 0.15}" y="-0.3" fill="#A5B3D9" font-size="0.4">${x}</text>`;
        }
      }
      for (let y = -7; y <= 7; y++) {
        if (y !== 0 && Math.abs(y) <= 7) {
          grid += `<text x="0.2" y="${-y + 0.2}" fill="#A5B3D9" font-size="0.4">${y}</text>`;
        }
      }

      let pointsSvg = '';
      if (points && points.length) {
        points.forEach(p => {
          pointsSvg += `<circle cx="${p.x}" cy="${-p.y}" r="0.25" fill="#FFB347" />`;
        });
      }

      const y1 = m * xMin + b;
      const y2 = m * xMax + b;
      const line = `<line x1="${xMin}" y1="${-y1}" x2="${xMax}" y2="${-y2}" stroke="#5ABFFF" stroke-width="0.15" />`;

      let highlight = '';
      
      if (!hideTarget) {
        if (highlightPoint) {
          highlight += `<circle cx="${highlightPoint.x}" cy="${-highlightPoint.y}" r="0.3" fill="#EB5757" />`;
        }
      }
      
      if (P) {
        highlight += `<circle cx="${P.x}" cy="${-P.y}" r="0.3" fill="#EB5757" />`;
      }
      if (nullstelle !== null) {
        const x0 = nullstelle;
        const y0 = 0;
        if (x0 >= xMin && x0 <= xMax) {
          highlight += `<circle cx="${x0}" cy="${-y0}" r="0.35" fill="#EB5757" />`;
          highlight += `<text x="${x0 + 0.4}" y="${-0.4}" fill="#EB5757" font-size="0.5">N</text>`;
        }
      }

      let triangle = '';
      if (drawTriangle && m !== 0) {
        // Steigungsdreieck immer am y-Achsenabschnitt startend, nach rechts
        // W√§hle run=2 (oder 1 falls Platz knapp)
        let run = 2;
        const startX = 0;
        const startY = b; // y-Achsenabschnitt
        // Pr√ºfe ob der y-Achsenabschnitt sichtbar ist
        if (Math.abs(startY) <= 6.5) {
          // Passe run an falls endY au√üerhalb w√§re
          let endX = startX + run;
          let endY = startY + m * run;
          if (Math.abs(endY) > 6.5 || endX > 6.5) {
            run = 1;
            endX = startX + run;
            endY = startY + m * run;
          }
          if (endX <= 7 && Math.abs(endY) <= 7) {
            const riseVal = m * run;
            triangle = `
              <circle cx="${startX}" cy="${-startY}" r="0.2" fill="#FFB347" opacity="0.8"/>
              <line x1="${startX}" y1="${-startY}" x2="${endX}" y2="${-startY}" stroke="#FFB347" stroke-width="0.12" stroke-dasharray="0.2 0.2" />
              <line x1="${endX}" y1="${-startY}" x2="${endX}" y2="${-endY}" stroke="#FFB347" stroke-width="0.12" stroke-dasharray="0.2 0.2" />
              <text x="${(startX + endX) / 2}" y="${-startY + 0.6}" fill="#FFB347" font-size="0.45" text-anchor="middle">${run}</text>
              <text x="${endX + 0.45}" y="${-(startY + riseVal / 2) + 0.15}" fill="#FFB347" font-size="0.45">${asFraction(riseVal)}</text>
            `;
          }
        }
      }

      return `
        <svg viewBox="${viewBox}" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
          ${grid}
          ${line}
          ${triangle}
          ${pointsSvg}
          ${highlight}
        </svg>
      `;
    }

    // =====================================================
    // ZOOM-FUNKTION
    // =====================================================
    function setupZoomableSVG(container, svgElement) {
      if (!container || !svgElement) return;
      
      zoomLevel = 1;
      
      const wrapper = document.createElement('div');
      wrapper.className = 'zoomable-svg';
      
      svgElement.parentNode.insertBefore(wrapper, svgElement);
      wrapper.appendChild(svgElement);
      
      wrapper.style.transform = `scale(${zoomLevel})`;
      
      wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        zoomLevel *= delta;
        zoomLevel = Math.min(Math.max(zoomLevel, MIN_ZOOM), MAX_ZOOM);
        wrapper.style.transform = `scale(${zoomLevel})`;
        updateZoomDisplay();
      });
      
      const controls = document.createElement('div');
      controls.className = 'zoom-controls';
      controls.innerHTML = `
        <button class="zoom-btn" id="zoomOut">‚àí</button>
        <span class="zoom-level" id="zoomDisplay">100%</span>
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomReset">‚Ü∫</button>
      `;
      
      container.appendChild(controls);
      
      document.getElementById('zoomIn').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomLevel *= 1.2;
        zoomLevel = Math.min(zoomLevel, MAX_ZOOM);
        wrapper.style.transform = `scale(${zoomLevel})`;
        updateZoomDisplay();
      });
      
      document.getElementById('zoomOut').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomLevel *= 0.8;
        zoomLevel = Math.max(zoomLevel, MIN_ZOOM);
        wrapper.style.transform = `scale(${zoomLevel})`;
        updateZoomDisplay();
      });
      
      document.getElementById('zoomReset').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomLevel = 1;
        wrapper.style.transform = `scale(1)`;
        updateZoomDisplay();
      });
      
      function updateZoomDisplay() {
        const display = document.getElementById('zoomDisplay');
        if (display) {
          display.textContent = Math.round(zoomLevel * 100) + '%';
        }
      }
    }

    // =====================================================
    // KLICK-FUNKTION F√úR KOORDINATEN-√úBUNG (KORRIGIERT)
    // =====================================================
    function setupCoordsClick(svg, ex, feedback) {
      if (!svg) return;
      
      svg.style.cursor = "crosshair";
      
      if (svg._clickHandler) {
        svg.removeEventListener('click', svg._clickHandler);
      }
      
      const handleClick = (e) => {
        // Use SVG's built-in coordinate transformation for accuracy
        const pt = svg.createSVGPoint();
        pt.x = e.clientX;
        pt.y = e.clientY;
        const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
        
        // svgP.x is the SVG x coordinate, svgP.y is SVG y (which is negated in our system)
        const x = svgP.x;
        const y = -svgP.y;  // invert because we draw with cy = -y
        
        const gridX = Math.round(x);
        const gridY = Math.round(y);
        
        const range = 8; // matches SVG viewBox xMin/xMax
        if (gridX >= -range && gridX <= range && gridY >= -range && gridY <= range) {
          const oldPoint = svg.querySelector('#user-point');
          if (oldPoint) oldPoint.remove();
          
          const point = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          point.id = "user-point";
          point.setAttribute("cx", gridX);
          point.setAttribute("cy", -gridY);
          point.setAttribute("r", "0.35");
          point.setAttribute("fill", "#FFD966");
          point.setAttribute("stroke", "white");
          point.setAttribute("stroke-width", "0.05");
          svg.appendChild(point);
          
          if (gridX === ex.target.x && gridY === ex.target.y) {
            feedback.textContent = '‚úÖ Richtig! Punkt getroffen.';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `‚ùå Falsch. Du hast (${gridX}|${gridY}) angeklickt. Gesucht: (${ex.target.x}|${ex.target.y})`;
            feedback.className = 'feedback error';
          }
        } else {
          feedback.textContent = `‚ö†Ô∏è Au√üerhalb des sichtbaren Bereichs. Zoome heraus oder w√§hle einen Punkt zwischen -${range} und ${range}.`;
          feedback.className = 'feedback';
        }
      };
      
      svg.addEventListener('click', handleClick);
      svg._clickHandler = handleClick;
    }

    // =====================================================
    // LEVEL SELECT ERSTELLEN
    // =====================================================
    function createLevelSelect() {
      const levelSelect = document.createElement("select");
      levelSelect.className = "level-select";
      levelSelect.innerHTML = `
        <option value="basic">üü¢ Basis (Zahlen -4 bis 4)</option>
        <option value="standard" selected>üü° Standard (Zahlen -6 bis 6)</option>
        <option value="advanced">üî¥ Erweitert (Zahlen -10 bis 10)</option>
      `;

      const mainContent = document.querySelector(".main-content");
      mainContent.prepend(levelSelect);

      levelSelect.addEventListener("change", (e) => {
        currentLevel = e.target.value;
        currentExample = generateExample(currentSection);
        render();
      });

      return levelSelect;
    }

    // =====================================================
    // RENDER
    // =====================================================
    function render() {
      const panel = document.getElementById('mainPanel');
      const section = currentSection;
      const ex = currentExample;

      let graphTitle = '';
      let graphSVG = '';
      let funcChips = '';

      if (section === 'coords') {
        graphTitle = 'üìç Punkt finden';
        graphSVG = renderSVG(0, 0, [], ex.target, false, null, null, true);
        funcChips = `<div class="chip"><i>Gesucht:</i> (${ex.target.x} | ${ex.target.y})</div>`;
      } else if (section === 'table') {
        graphTitle = 'üìä Wertetabelle ‚Üí Graph';
        graphSVG = renderSVG(ex.m, ex.b, ex.xs.map((x, i) => ({ x, y: ex.ys[i] })));
        funcChips = `<div class="chip"><i>y =</i> ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}</div>`;
      } else if (section === 'normalform') {
        graphTitle = 'üìà Steigung & Achsenabschnitt';
        graphSVG = renderSVG(ex.m, ex.b, [], null, true);
        funcChips = '';
      } else if (section === 'parallel') {
        graphTitle = '‚ö° Parallele & Senkrechte';
        graphSVG = renderSVG(ex.m, ex.b, [], null, false, ex.P);
        funcChips = `<div class="chip"><i>m =</i> ${asFraction(ex.m)}</div><div class="chip"><i>P =</i> (${ex.P.x}|${ex.P.y})</div>`;
      } else {
        graphTitle = '‚ùå Nullstellen berechnen';
        graphSVG = renderSVG(ex.m, ex.b, [], null, false, null, ex.nullstelle);
        funcChips = `<div class="chip"><i>f(x) =</i> ${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)}</div>`;
      }

      let exerciseHTML = '';

      if (section === 'coords') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>üéØ</span> Klick-√úbung</div>
            <div class="input-group">
              <div class="step-row">
                <span class="step-label">Klicke direkt auf den gesuchten Punkt im Koordinatensystem</span>
                <span class="step-hint">Der rote Punkt dient als Referenz und wird nicht angezeigt</span>
                <span class="step-hint">Bei Bedarf kannst du mit den Buttons zoomen</span>
              </div>
            </div>
            <div class="button-group">
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="coordsFeedback">Klicke auf den Punkt (${ex.target.x}|${ex.target.y}).</div>
          </div>
        `;
      } else if (section === 'table') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>üìù</span> Tabelle</div>
            <div class="input-group">
              ${ex.xs.map((x, idx) => `
                <div class="table-row">
                  <span class="table-label">x=${x}</span>
                  <input type="text" id="tableInput${idx}" placeholder="y">
                </div>
              `).join('')}
            </div>
            <div class="button-group">
              <button class="btn" id="tableCheckBtn">‚úÖ Pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="tableFeedback">Trage die y-Werte ein.</div>
          </div>
        `;
      } else if (section === 'normalform') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>üìê</span> m & b bestimmen</div>
            <div class="input-group">
              <input type="text" id="normalM" placeholder="Steigung m (z.B. 2 oder 3/4)">
              <input type="text" id="normalB" placeholder="Achsenabschnitt b">
            </div>
            <div class="button-group">
              <button class="btn" id="normalCheckBtn">üîç Pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="normalFeedback">Lies m und b aus dem Graphen ab.</div>
          </div>
        `;
      } else if (section === 'parallel') {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>‚ö°</span> Parallele Geraden Schritt f√ºr Schritt</div>
            <div class="input-group">
              <div class="step-row">
                <span class="step-label">1Ô∏è‚É£ Steigung f√ºr Parallele</span>
                <input type="text" id="parallelStep1" placeholder="m‚à• = ? (gleiche Steigung)">
                <span class="step-hint">Parallele haben gleiche Steigung m = ${asFraction(ex.m)}</span>
              </div>
              <div class="step-row">
                <span class="step-label">2Ô∏è‚É£ b der Parallelen berechnen</span>
                <input type="text" id="parallelStep2" placeholder="b‚à• = y - m¬∑x">
                <span class="step-hint">Punkt P (${ex.P.x}|${ex.P.y}) einsetzen</span>
              </div>
              <div class="step-row">
                <span class="step-label">3Ô∏è‚É£ Senkrechte: Steigung m‚ä•</span>
                <input type="text" id="parallelStep3" placeholder="m‚ä• = -1/m">
                <span class="step-hint">m‚ä• = -1 / ${asFraction(ex.m)}</span>
              </div>
              <div class="step-row">
                <span class="step-label">4Ô∏è‚É£ b der Senkrechten berechnen</span>
                <input type="text" id="parallelStep4" placeholder="b‚ä• = y - m‚ä•¬∑x">
                <span class="step-hint">Punkt P (${ex.P.x}|${ex.P.y}) einsetzen</span>
              </div>
            </div>
            <div class="button-group">
              <button class="btn" id="parallelStepCheckBtn">üîç Schritte pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="parallelStepFeedback">F√ºlle jeden Schritt nacheinander aus.</div>
          </div>
        `;
      } else {
        exerciseHTML = `
          <div class="exercise-card">
            <div class="exercise-title"><span>‚ùå</span> Nullstellen Schritt f√ºr Schritt</div>
            <div class="input-group">
              <div class="step-row">
                <span class="step-label">1Ô∏è‚É£ f(x) = 0 setzen</span>
                <input type="text" id="step1" placeholder="z.B. 0 oder f(x)=0">
              </div>
              <div class="step-row">
                <span class="step-label">2Ô∏è‚É£ Funktion einsetzen</span>
                <input type="text" id="step2" placeholder="mx + b = 0">
              </div>
              <div class="step-row">
                <span class="step-label">3Ô∏è‚É£ b auf andere Seite</span>
                <input type="text" id="step3" placeholder="mx = -b">
              </div>
              <div class="step-row">
                <span class="step-label">4Ô∏è‚É£ Durch m dividieren</span>
                <input type="text" id="step4" placeholder="x = -b/m">
              </div>
              <div class="step-row">
                <span class="step-label">5Ô∏è‚É£ Nullstelle</span>
                <input type="text" id="step5" placeholder="x = ...">
              </div>
            </div>
            <div class="button-group">
              <button class="btn" id="nullstellenCheckBtn">üîç Schritte pr√ºfen</button>
              <button class="btn btn-primary" id="newExampleBtn">‚ú® Neu</button>
            </div>
            <div class="feedback" id="nullstellenFeedback">F√ºlle jeden Schritt aus.</div>
          </div>
        `;
      }

      panel.innerHTML = `
        <div class="graph-area">
          <div class="graph-title">
            <span>${graphTitle}</span>
          </div>
          <div class="svg-container" id="svgContainer">
            ${graphSVG}
          </div>
          <div class="func-info">
            ${funcChips}
          </div>
        </div>
        <div class="exercise-area">
          ${exerciseHTML}
        </div>
      `;

      document.querySelectorAll('.nav-item:not(#pdfExportBtn)').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === currentSection) btn.classList.add('active');
      });

      const container = document.getElementById('svgContainer');
      const svg = container.querySelector('svg');
      if (svg) {
        setupZoomableSVG(container, svg);
      }

      document.querySelectorAll('#newExampleBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentExample = generateExample(currentSection);
          render();
        });
      });

      document.querySelectorAll('.nav-item[data-section]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentSection = e.currentTarget.dataset.section;
          currentExample = generateExample(currentSection);
          render();
        });
      });

      if (section === 'coords') {
        const svg = document.querySelector('#svgContainer svg');
        const feedback = document.getElementById('coordsFeedback');
        if (svg && feedback) {
          setupCoordsClick(svg, ex, feedback);
        }
      }

      if (section === 'table') {
        const checkBtn = document.getElementById('tableCheckBtn');
        const feedback = document.getElementById('tableFeedback');
        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            let allCorrect = true;
            for (let i = 0; i < ex.xs.length; i++) {
              const inp = document.getElementById(`tableInput${i}`);
              if (inp) {
                const val = parseFloat(inp.value.replace(',', '.'));
                if (isNaN(val) || Math.abs(val - ex.ys[i]) > 0.01) {
                  allCorrect = false;
                  inp.style.borderColor = '#EB5757';
                } else {
                  inp.style.borderColor = '#6FCF97';
                }
              }
            }
            if (allCorrect) {
              feedback.textContent = '‚úÖ Tabelle richtig!';
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = '‚ùå Nicht alle Werte stimmen.';
              feedback.className = 'feedback error';
            }
          });
        }
      }

      if (section === 'normalform') {
        const checkBtn = document.getElementById('normalCheckBtn');
        const mInp = document.getElementById('normalM');
        const bInp = document.getElementById('normalB');
        const feedback = document.getElementById('normalFeedback');
        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const mVal = parseFloat(mInp.value.replace(',', '.'));
            const bVal = parseFloat(bInp.value.replace(',', '.'));
            if (!isNaN(mVal) && !isNaN(bVal) && Math.abs(mVal - ex.m) < 0.01 && Math.abs(bVal - ex.b) < 0.01) {
              feedback.textContent = `‚úÖ Korrekt! m = ${asFraction(ex.m)}, b = ${ex.b}`;
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = `‚ùå Falsch. Tipp: m = ${asFraction(ex.m)}, b = ${ex.b}`;
              feedback.className = 'feedback error';
            }
          });
        }
      }

      if (section === 'parallel') {
        const checkBtn = document.getElementById('parallelStepCheckBtn');
        const feedback = document.getElementById('parallelStepFeedback');
        const step1 = document.getElementById('parallelStep1');
        const step2 = document.getElementById('parallelStep2');
        const step3 = document.getElementById('parallelStep3');
        const step4 = document.getElementById('parallelStep4');

        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const expected1 = asFraction(ex.m);
            const expected2 = asFraction(ex.bPar);
            const expected3 = asFraction(ex.mPerp);
            const expected4 = asFraction(ex.bPerp);

            const val1 = step1.value.trim().replace(/\s+/g, '');
            const val2 = step2.value.trim().replace(/\s+/g, '');
            const val3 = step3.value.trim().replace(/\s+/g, '');
            const val4 = step4.value.trim().replace(/\s+/g, '');

            const step1OK = val1 === expected1 || val1 === ex.m.toString() || Math.abs(parseFloat(val1) - ex.m) < 0.01;
            const step2OK = val2 === expected2 || val2 === ex.bPar.toString() || Math.abs(parseFloat(val2) - ex.bPar) < 0.01;
            const step3OK = val3 === expected3 || val3 === ex.mPerp.toString() || Math.abs(parseFloat(val3) - ex.mPerp) < 0.01;
            const step4OK = val4 === expected4 || val4 === ex.bPerp.toString() || Math.abs(parseFloat(val4) - ex.bPerp) < 0.01;

            step1.style.borderColor = step1OK ? '#6FCF97' : '#EB5757';
            step2.style.borderColor = step2OK ? '#6FCF97' : '#EB5757';
            step3.style.borderColor = step3OK ? '#6FCF97' : '#EB5757';
            step4.style.borderColor = step4OK ? '#6FCF97' : '#EB5757';

            if (step1OK && step2OK && step3OK && step4OK) {
              feedback.textContent = `‚úÖ Alle Schritte korrekt!`;
              feedback.className = 'feedback success';
            } else {
              const wrongSteps = [];
              if (!step1OK) wrongSteps.push('1');
              if (!step2OK) wrongSteps.push('2');
              if (!step3OK) wrongSteps.push('3');
              if (!step4OK) wrongSteps.push('4');
              feedback.textContent = `‚ùå Schritt(e) ${wrongSteps.join(', ')} nicht korrekt.`;
              feedback.className = 'feedback error';
            }
          });
        }
      }

      if (section === 'nullstellen') {
        const checkBtn = document.getElementById('nullstellenCheckBtn');
        const feedback = document.getElementById('nullstellenFeedback');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');

        if (checkBtn) {
          checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const expected1 = '0';
            const expected2 = `${asFraction(ex.m)}x ${ex.b >= 0 ? '+' : '-'} ${Math.abs(ex.b)} = 0`;
            const expected3 = `${asFraction(ex.m)}x = ${-ex.b}`;
            const expected4 = `x = ${asFraction(-ex.b)} / ${asFraction(ex.m)}`;
            const expected5 = ex.nullstelle !== null ? `x = ${ex.nullstelle.toFixed(2)}` : 'keine Nullstelle';

            const val1 = step1.value.trim();
            const step1OK = val1 === '0' || val1 === 'f(x)=0' || val1 === 'f(x) = 0';
            
            const val2 = step2.value.trim().replace(/\s+/g, '');
            const expected2clean = expected2.replace(/\s+/g, '');
            const step2OK = val2 === expected2clean || (val2.includes(`${asFraction(ex.m)}x`) && val2.includes('=0'));
            
            const val3 = step3.value.trim().replace(/\s+/g, '');
            const expected3clean = expected3.replace(/\s+/g, '');
            const step3OK = val3 === expected3clean || (val3.includes(`${asFraction(ex.m)}x=`) && val3.includes(`${-ex.b}`));
            
            const val4 = step4.value.trim().replace(/\s+/g, '');
            const expected4clean = expected4.replace(/\s+/g, '');
            const step4OK = val4 === expected4clean || (val4.includes('x=') && val4.includes('/'));
            
            const val5 = step5.value.trim();
            let step5OK = false;
            if (ex.nullstelle !== null) {
              step5OK = val5.includes(ex.nullstelle.toFixed(2)) || val5.includes(asFraction(ex.nullstelle));
            } else {
              step5OK = val5.toLowerCase().includes('keine') || val5.includes('unendlich');
            }

            step1.style.borderColor = step1OK ? '#6FCF97' : '#EB5757';
            step2.style.borderColor = step2OK ? '#6FCF97' : '#EB5757';
            step3.style.borderColor = step3OK ? '#6FCF97' : '#EB5757';
            step4.style.borderColor = step4OK ? '#6FCF97' : '#EB5757';
            step5.style.borderColor = step5OK ? '#6FCF97' : '#EB5757';

            if (step1OK && step2OK && step3OK && step4OK && step5OK) {
              feedback.textContent = `‚úÖ Alle Schritte korrekt!`;
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = `‚ùå Einige Schritte nicht korrekt.`;
              feedback.className = 'feedback error';
            }
          });
        }
      }
    }

    // =====================================================
    // INITIALISIERUNG
    // =====================================================
    document.addEventListener('DOMContentLoaded', () => {
      createLevelSelect();

      // Header-H√∂he dynamisch als CSS-Variable setzen
      function updateHeaderHeight() {
        const header = document.getElementById('appHeader');
        if (header) {
          document.getElementById('mainContent').style.marginTop = header.offsetHeight + 'px';
        }
      }
      updateHeaderHeight();
      window.addEventListener('resize', updateHeaderHeight);

      // QR-Code Button
      const qrBtn = document.getElementById('qrBtn');
      const qrModal = document.getElementById('qrModal');
      const qrClose = document.getElementById('qrClose');
      const qrCanvas = document.getElementById('qrCanvas');
      const qrUrlEl = document.getElementById('qrUrl');

      if (qrBtn) {
        qrBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const url = window.location.href;
          qrUrlEl.textContent = url;
          // Canvas leeren
          const ctx = qrCanvas.getContext('2d');
          qrCanvas.width = 180;
          qrCanvas.height = 180;
          ctx.clearRect(0, 0, 180, 180);
          // QR-Code zeichnen
          try {
            // qrcodejs nutzt DOM, wir brauchen einen Hilfs-div
            const tmpDiv = document.createElement('div');
            tmpDiv.style.display = 'none';
            document.body.appendChild(tmpDiv);
            new QRCode(tmpDiv, {
              text: url,
              width: 180,
              height: 180,
              colorDark: '#000000',
              colorLight: '#ffffff',
            });
            // Nach kurzer Verz√∂gerung das erzeugte Canvas/Img kopieren
            setTimeout(() => {
              const img = tmpDiv.querySelector('img') || tmpDiv.querySelector('canvas');
              if (img) {
                const tempImg = new Image();
                tempImg.onload = () => ctx.drawImage(tempImg, 0, 0, 180, 180);
                tempImg.src = img.tagName === 'CANVAS' ? img.toDataURL() : img.src;
              }
              document.body.removeChild(tmpDiv);
            }, 100);
          } catch(err) {
            ctx.fillStyle = '#333';
            ctx.font = '12px sans-serif';
            ctx.fillText('QR-Code nicht', 10, 80);
            ctx.fillText('verf√ºgbar', 35, 100);
          }
          qrModal.classList.add('open');
        });
      }

      if (qrClose) {
        qrClose.addEventListener('click', () => qrModal.classList.remove('open'));
      }
      if (qrModal) {
        qrModal.addEventListener('click', (e) => {
          if (e.target === qrModal) qrModal.classList.remove('open');
        });
      }

      const pdfBtn = document.getElementById('pdfExportBtn');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', (e) => {
          e.preventDefault();
          exportPDF();
        });
      }

      currentExample = generateExample(currentSection);
      render();
    });
  })();
</script>
</body>
</html>
